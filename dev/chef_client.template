heat_template_version: 2013-05-23
parameters:
  chef_server_url:
    type: string
    description: Url to the chef server

  run_list:
    type: string
    description: |
      The initial run list to execute. Ex:
        - "recipe[apache2]"
        - "role[db]"

  validation_name:
    type: string
    default: "yourorg-validator"

  attributes:
    type: string
    description: |
      Attributes to apply for the chef run. Ex:
        apache:
            prefork:
                maxclients: 100
            keepalive: "off"

  image_id:
    type: string
    description: Server image id to use
    default: bba8bce7-403a-4dd6-80e7-0c40dcc7cd06  # Ubuntu 12.04 LTS (Precise Pangolin)

  flavor:
    description: Rackspace Cloud Server flavor
    type: string 
    default: performance1-1
    constraints:
    - allowed_values:
      - performance1-1
      description: must be a valid Rackspace Cloud Server flavor.

  server_name:
    description: the instance name
    type: string
    default: ChefClient

  key_name:
    description: Nova keypair name for ssh access to the server
    type: string

resources:
  chef_client:
    type: "OS::Nova::Server"
    properties:
      flavor: { get_param: flavor }
      image: { get_param: image_id }
      name: { get_param: server_name }
      key_name: { get_param: key_name }
      config_drive: "true"
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            chef:
             #omnibus not work with cloud-init 0.6.3
             install_type: "gems"
             validation_name: "%validation_name%"
             force_install: false
             server_url: "%chef_server_url%"
             run_list:
                %run_list% 
             initial_attributes:
               %attributes% 
             validation_key: |
                -----BEGIN RSA PRIVATE KEY-----
                #YOUR_VALIDATION_KEY
                -----END RSA PRIVATE KEY-----
            output: {all: '| tee -a /var/log/cloud-init-output.log'}
          params:
            "%chef_server_url%": {get_param: chef_server_url}
            "%attributes%": {get_param: attributes}
            "%run_list%": {get_param: run_list}
            "%validation_name%": {get_param: validation_name}

outputs:
  public_ip:
    value: { get_attr: [ chef_client, accessIPv4 ] }
    description: The public ip address of the server